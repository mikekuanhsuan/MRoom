-- 1. 改用 # 暫存表
CREATE TABLE #LEFT (
    CIF_KEY uniqueidentifier PRIMARY KEY -- 建立主鍵會自動產生索引
);

-- 2. 插入資料
INSERT INTO #LEFT
SELECT CIF_KEY 
FROM BSADBTW..HRS_CUST_RISK_MGMT WITH (NOLOCK) 
WHERE STATUS <> '3';

-- 3. 主查詢 (邏輯不變，只需把 @LEFT 改成 #LEFT)
SELECT 
    '_' + A.CustomerNo,
    CASE WHEN C.CIF_KEY IS NOT NULL THEN '' ELSE B.ReviewDt END AS NEXT_ReviewDt,
    CASE WHEN C.CIF_KEY IS NOT NULL THEN 'Y' ELSE 'N' END AS RM_CASE
FROM @TT T
JOIN BSADBTW..BSA_SUB_CUST_FACT AS A WITH (NOLOCK) ON A.CustomerNo = T.CustomerNo
JOIN BSADBTW..PB_CUSTOMER_FACT AS D WITH (NOLOCK) ON A.CIF_KEY = D.CIF_KEY
LEFT JOIN BSADBTW..EDD_ReviewSchedule AS B WITH (NOLOCK) ON A.CIF_KEY = B.CIFKey AND B.status = 'P'
LEFT JOIN #LEFT AS C ON A.CIF_KEY = C.CIF_KEY;

-- 4. 用完記得刪除 (好習慣)
DROP TABLE #LEFT;
