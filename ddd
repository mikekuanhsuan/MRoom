-- 前面 #LEFT 與 #EDD 的部分保持不變 --

-- 修改後的最後一段查詢：
SELECT 
    '_' + A.CustomerNo AS CustomerNo, -- 建議加上 Alias 較清晰
    CASE WHEN C.CIF_KEY IS NOT NULL THEN '' ELSE B.ReviewDt END AS NEXT_ReviewDt,
    CASE WHEN C.CIF_KEY IS NOT NULL THEN 'Y' ELSE 'N' END AS RM_CASE
FROM @TT T
JOIN BSADBTW..BSA_SUB_CUST_FACT AS A WITH (NOLOCK) ON A.CustomerNo = T.CustomerNo
JOIN BSADBTW..PB_CUSTOMER_FACT AS D WITH (NOLOCK) ON A.CIF_KEY = D.CIF_KEY
LEFT JOIN #EDD AS B ON A.CIF_KEY = B.CIFKey
LEFT JOIN #LEFT AS C ON A.CIF_KEY = C.CIF_KEY 
WHERE D.customer_segment <> 'NCR' -- 在這裡新增過濾條件 (用 != 或 <> 都可以)
